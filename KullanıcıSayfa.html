<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KullanÄ±cÄ± Paneli - Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <link rel="stylesheet" href="KullanÄ±cÄ±Sayfa.css" />
    <link rel="stylesheet" href="anketler/anketler.css"/>
    <link rel="stylesheet" href="anketler/style-bigfive.css"/>
    <link rel="stylesheet" href="anketler/style-kolbs.css"/>
    <link rel="stylesheet" href="anketler/style-testler.css"/>
    <link rel="stylesheet" href="anketler/style-RIASEC.css"/>
 <script>
      if (!localStorage.getItem('userToken')) {
        alert('Bu sayfayÄ± gÃ¶rÃ¼ntÃ¼lemek iÃ§in lÃ¼tfen giriÅŸ yapÄ±n.');
        window.location.href = 'index.html'; 
      }
    </script>
  </head>
  <body>
    <div class="d-flex">
      <!-- Sidebar -->
      <nav id="sidebar">
        <div class="sidebar-header">
          <h3>Kut-AI</h3>
        </div>

        <div class="sidebar-user-info">
          <h5 class="user-username-display">Username</h5>
          <span class="badge bg-success">Ã–ÄŸrenci</span>
        </div>

        <ul class="sidebar-nav">
          <li>
            <a href="#dashboard" class="active" data-content="dashboard">
              <i class="bi bi-speedometer2"></i> Dashboard
            </a>
          </li>
          <li>
            <a href="#oyun" data-content="oyun">
              <i class="bi bi-joystick"></i> Oyun
            </a>
          </li>
          <li>
            <a href="#raporlar" data-content="raporlar">
              <i class="bi bi-file-text"></i> Raporlar
            </a>
          </li>
          <li>
            <a href="#analizler" data-content="analizler">
              <i class="bi bi-bar-chart"></i> Analizler
            </a>
          </li>
         <a href="#anketler" onclick="loadPage('partials/anketler.html', 'loadAnket')" data-content="anketler">
  <i class="bi bi-clipboard-data"></i> Anketler
</a>
</li>
 </ul>

       
        <div class="sidebar-footer">
          <ul class="sidebar-nav">
            <li>
              <a href="#ayarlar" data-content="ayarlar">
                <i class="bi bi-gear"></i> Ayarlar
              </a>
            </li>
            <li>
              <a href="#" id="logout-link">
                <i class="bi bi-box-arrow-right"></i> Ã‡Ä±kÄ±ÅŸ Yap
              </a>
            </li>
          </ul>
        </div>
      </nav>


      <!-- Ana Ä°Ã§erik -->
      <div id="content">
        <!-- Topbar -->
        <div class="topbar mb-4">
          <div class="d-flex align-items-center">
            <span class="menu-toggle"><i class="bi bi-list"></i></span>
            <a href="javascript:history.back()" class="back-button">
              <i class="bi bi-arrow-left"></i>
            </a>
              <div class="d-flex align-items-center">
            <h4 class="mb-0">KullanÄ±cÄ± Paneli</h4>
          </div>
        </div>

        <!-- Ä°Ã§erik AlanÄ± -->
        <div class="container-fluid">
          <!-- Dashboard Ä°Ã§eriÄŸi -->
          <div id="dashboard-content" class="content-section">
            <div class="row">
              <div class="col-xl-8">
                <!-- HoÅŸ Geldiniz KartÄ± -->
                <div class="card dashboard-card">
                  <div class="card-body">
                    <h4 class="card-title">
                      HoÅŸ Geldiniz,
                      <span class="user-username-display">Username</span>!
                    </h4>
                    <p class="card-text">
                      Kut-AI psikolojik destek platformuna hoÅŸ geldiniz.
                      AÅŸaÄŸÄ±daki butondan oyunu oynayabilir veya sol menÃ¼den
                      diÄŸer seÃ§eneklere ulaÅŸabilirsiniz.
                    </p>
              
                  </div>
                </div>

                <!-- Oyun BÃ¶lÃ¼mÃ¼ -->
                <div class="card dashboard-card">
                  <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold">Oyun</h6>
                  </div>
                  <div class="card-body p-0">
                    <div class="game-container" style="background-color:  #4c73e7;">

                      <div class="overlay">
                        <h3>Psikolojik Destek Oyunu</h3>
                        <p>
                          Oyunumuzu oynayarak psikolojik durumunuz hakkÄ±nda
                          bilgi sahibi olabilirsiniz.
                        </p>
                        <a
                          href="https://xn--kuta-oza.com/oyun" target="_blank" 
                          class="btn btn-danger game-btn"
                          id="btnoyna"
                          >Oyunu Oyna</a
                        >
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-xl-4">

                <!-- Psikolojik Durum Analizi -->
                <div class="card dashboard-card">
                  <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold">
                      Psikolojik Durum Analizi
                    </h6>
                  </div>
                  <div class="card-body">
                    <div class="mb-3">
                
                      <!-- DÄ±ÅŸadÃ¶nÃ¼klÃ¼k -->
                      <p class="small text-muted mb-1" id="text-disadonukluk">DÄ±ÅŸadÃ¶nÃ¼klÃ¼k: %0</p>
                      <div class="progress mb-3">
                        <div id="bar-disadonukluk" class="progress-bar bg-danger" role="progressbar" style="width: 0%"></div>
                      </div>
                
                      <!-- Uyumluluk -->
                      <p class="small text-muted mb-1" id="text-uyumluluk">Uyumluluk: %0</p>
                      <div class="progress mb-3">
                        <div id="bar-uyumluluk" class="progress-bar bg-warning" role="progressbar" style="width: 0%"></div>
                      </div>
                
                      <!-- Sorumluluk -->
                      <p class="small text-muted mb-1" id="text-sorumluluk">Sorumluluk: %0</p>
                      <div class="progress mb-3">
                        <div id="bar-sorumluluk" class="progress-bar bg-info" role="progressbar" style="width: 0%"></div>
                      </div>
                
                      <!-- Duygusal Denge -->
                      <p class="small text-muted mb-1" id="text-duygusaldenge">Duygusal Denge: %0</p>
                      <div class="progress mb-3">
                        <div id="bar-duygusaldenge" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                      </div>
                
                    </div>
                  </div>
                </div>
               
              
              
              <div class="card dashboard-card">
                  <div class="card-header py-3">
                  <h6 class="m-0 font-weight-bold">Son Raporlar</h6>
                 </div>
             <div class="card-body">
              <div id="latest-reports" class="list-group list-group-flush"></div>
            </div>
          </div>

            <!-- Status container -->
         <div id="latest-report-status" class="mt-3"></div>
          </div>
              </div>
            </div>
          </div>
   

          <!-- DiÄŸer Ä°Ã§erik BÃ¶lÃ¼mleri (BaÅŸlangÄ±Ã§ta Gizli) -->
          <div id="oyun-content" class="content-section d-none">
            <div class="card dashboard-card">
              <div class="card-header py-4">
                <h6 class="m-0 font-weight-bold">Oyun</h6>
              </div>
              <div class="card-body p-0">
                <div class="game-container" style="background-color:  #4c73e7;">
                  <div class="overlay">
                    <h3>Psikolojik Destek Oyunu</h3>
                    <p>
                      Oyunumuzu oynayarak psikolojik durumunuz hakkÄ±nda bilgi
                      sahibi olabilirsiniz.
                    </p>
                    <a
                      href="https://xn--kuta-oza.com/oyun" target="_blank"
                      class="btn btn-danger game-btn"
                      id="btnoyna2"
                      >Oyunu Oyna</a
                    >
                  </div>
                </div>
              </div>
            </div>
          </div>

 <div id="raporlar-content" class="content-section d-none">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h4 class="mb-0">RaporlarÄ±m</h4>
              <button class="btn btn-sm btn-outline-primary">
                <i class="bi bi-download"></i> TÃ¼mÃ¼nÃ¼ Ä°ndir
              </button>
            </div>

            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Rapor AdÄ±</th>
                    <th>OluÅŸturulma Tarihi</th>
                    <th>Ä°ÅŸlemler</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div id="report-status-container" class="mt-4"></div>
          </div>

          <div id="analizler-content" class="content-section d-none">
            <h4 class="mb-4">Mevcut Analizler</h4>
             <div class="row">
              <!-- IPIP Analizi -->
              <div class="col-12 mb-4">
                <div class="card analysis-card">
                  <div class="card-header bg-white py-3">
                    <h5 class="mb-0">
                      <i class="bi bi-bar-chart trait-icon"></i> IPIP KiÅŸilik
                      Ã–zellikleri Analizi
                    </h5>
                  </div>
                  <div class="card-body">
                    <div class="chart-container">
                      <canvas id="ipipChart"></canvas>
                    </div>
                  </div>
                </div>
              </div>

              <!-- GAD-7 Analizi -->
              <div class="col-md-6 mb-4">
                <div class="card analysis-card h-100">
                  <div class="card-header bg-white py-3">
                    <h5 class="mb-0">
                      <i class="bi bi-clipboard-pulse trait-icon"></i> GAD-7
                      Anksiyete Analizi
                    </h5>
                  </div>
                  <div class="card-body">
                    <div class="chart-container">
                      <canvas id="gad7Chart"></canvas>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Kariyer Ã–nerileri -->
              <div class="col-md-6 mb-4">
                <div class="card analysis-card h-100">
                  <div class="card-header bg-white py-3">
                    <h5 class="mb-0">
                      <i class="bi bi-briefcase trait-icon"></i> Kariyer
                      Ã–nerileri
                    </h5>
                  </div>
                  <div class="card-body">
                    <div class="radar-chart-container">
                      <canvas id="careerChart"></canvas>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Yapay Zeka Yorumu -->
              <div class="col-12">
                <div class="card analysis-card">
                  <div class="card-header bg-white py-3">
                    <h5 class="mb-0">
                      <i class="bi bi-robot trait-icon"></i> Yapay Zeka Yorumu
                    </h5>
                  </div>
                  <div class="card-body">
                    <div class="d-flex">
                      <div class="flex-shrink-0">
                        <i class="bi bi-chat-quote display-4 text-primary"></i>
                      </div>
                      <div class="flex-grow-1 ms-3">
                        <p id="aiComment" class="mb-0 fst-italic">
                          "Analiz yÃ¼kleniyor..."
                        </p>
                      </div>
                    </div>
                    <div class="mt-3 text-end">
                      <small class="text-muted"
                        >TULPAR: Kut-AI Psikolojik Analiz Sistemi</small
                      >
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="anketler-content" class="content-section d-none">
            <h4 class="mb-4">Mevcut Anketler</h4>

                <div class="card border-0 shadow-sm h-100">
                  <div id="loadAnket"></div>
               
                    
                </div>
              </div>

          
       
         

          <div id="ayarlar-content" class="content-section d-none">
            <div class="card dashboard-card">
              <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold">Hesap AyarlarÄ±</h6>
              </div>
              <div class="card-body">
                <form>
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="firstName" class="form-label">Ad</label>
                      <input
                        type="text"
                        class="form-control"
                        id="firstName"
                        value="Name"
                      />
                    </div>
                    <div class="col-md-6">
                      <label for="lastName" class="form-label">Soyad</label>
                      <input
                        type="text"
                        class="form-control"
                        id="lastName"
                        value="Surname"
                      />
                    </div>
                  </div>
                  <div class="mb-3">
                    <label for="email" class="form-label">E-posta</label>
                    <input
                      type="email"
                      class="form-control"
                      id="email"
                      value="username@example.com"
                    />
                  </div>
                  <div class="mb-3">
                    <label for="password" class="form-label">Yeni Åžifre</label>
                    <input
                      type="password"
                      class="form-control"
                      id="password"
                      placeholder="Åžifrenizi deÄŸiÅŸtirmek iÃ§in buraya yazÄ±n"
                    />
                  </div>
                  <div class="mb-3">
                    <label for="confirmPassword" class="form-label"
                      >Åžifreyi Onayla</label
                    >
                    <input
                      type="password"
                      class="form-control"
                      id="confirmPassword"
                      placeholder="Yeni ÅŸifrenizi tekrar girin"
                    />
                  </div>
                  <button type="submit" class="btn btn-primary">
                    DeÄŸiÅŸiklikleri Kaydet
                  </button>
                </form>
              </div>
            </div>
          </div>
             </div>
</div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
function loadPage(page, targetId = "loadAnket") {
  fetch(page)
    .then(res => res.text())
    .then(data => {
      const container = document.getElementById(targetId);
      container.innerHTML = data;

      // Partial iÃ§indeki scriptleri Ã§alÄ±ÅŸtÄ±r
      container.querySelectorAll("script").forEach(oldScript => {
        const newScript = document.createElement("script");
        if (oldScript.src) newScript.src = oldScript.src;
        else newScript.textContent = oldScript.textContent;
        document.body.appendChild(newScript);
      });

      // EÄŸer init fonksiyon varsa Ã§aÄŸÄ±r
      if (typeof initRiasecTest === "function") initRiasecTest();
    })
    .catch(err => console.error("Sayfa yÃ¼klenemedi:", err));
}



  document.addEventListener("DOMContentLoaded", function () {
    // ==========================================================
    // GÄ°RÄ°Åž YAPAN KULLANICI BÄ°LGÄ°LERÄ°NÄ° SAYFAYA YAZDIRMA
    // ==========================================================
    const loggedInUsername = localStorage.getItem("username");
    const loggedInUserEmail = localStorage.getItem("userEmail");

    if (loggedInUsername) {
        const sidebarNameElements = document.querySelectorAll(".user-username-display");
        sidebarNameElements.forEach((el) => el.textContent = loggedInUsername);

        const dropdownButton = document.getElementById("dropdownMenuButton");
        if (dropdownButton) {
            dropdownButton.innerHTML = `<i class="bi bi-person-circle me-1"></i> ${loggedInUsername}`;
        }
    }

    // ==========================================================
    // Ã‡IKIÅž YAPMA Ä°ÅžLEVSELLÄ°ÄžÄ°
    // ==========================================================
    const logoutLink = document.getElementById("logout-link");
    if (logoutLink) {
        logoutLink.addEventListener("click", function (event) {
            event.preventDefault();
            localStorage.clear();
            alert("BaÅŸarÄ±yla Ã§Ä±kÄ±ÅŸ yaptÄ±nÄ±z.");
            window.location.href = "index.html";
        });
    }

    // ==========================================================
    // OYUN OYNAMA BUTONU Ä°ÅžLEVSELLÄ°ÄžÄ°
    // ==========================================================
    const oynaButonlari = document.querySelectorAll("#btnoyna, #btnoyna2");
    oynaButonlari.forEach((btn) => {
        btn.addEventListener("click", function () {
            const loggedInUserId = localStorage.getItem("userId");
            if (loggedInUserId) {
                const baseUrl = window.location.origin;
                window.location.href = `${baseUrl}/oyun?userId=${loggedInUserId}`;
            } else {
                alert("Oyun oynamak iÃ§in giriÅŸ yapmalÄ±sÄ±nÄ±z.");
                window.location.href = "index.html";
            }
        });
    });

    // ==========================================================
    // SIDEBAR NAVÄ°GASYON VE Rapor YÃ¼kleme
    // ==========================================================
    const navLinks = document.querySelectorAll("nav#sidebar a[data-content]");
    
    const contentSections = document.querySelectorAll(".content-section");

navLinks.forEach((link) => {
    link.addEventListener("click", function (e) {
        e.preventDefault();
        navLinks.forEach((l) => l.classList.remove("active"));
        this.classList.add("active");

        const targetContent = this.getAttribute("data-content");
        contentSections.forEach((section) => section.classList.add("d-none"));
        document.getElementById(`${targetContent}-content`).classList.remove("d-none");

        // Raporlar sayfasÄ±na tÄ±klandÄ±ÄŸÄ±nda raporlarÄ± yeniden yÃ¼kle
        if (targetContent === "raporlar") {
            loadReportsTable();
        }

        // ðŸ”¥ MenÃ¼den bir ÅŸey seÃ§ildiÄŸinde sidebarâ€™Ä± kapat
        const sidebar = document.getElementById("sidebar");
        const content = document.getElementById("content");
        sidebar.classList.remove("active");
        content.classList.remove("full");
    });
});


    // ==========================================================
    // FONKSÄ°YONLAR
    // ==========================================================

    // Raporlar Tablosunu Doldurma (raporlar sayfasÄ± iÃ§in)
    async function loadReportsTable() {
        const raporlarTableBody = document.querySelector('#raporlar-content table tbody');
        const username = localStorage.getItem('username');
        if (!username) {
            raporlarTableBody.innerHTML = `<tr><td colspan="3">GiriÅŸ yapmalÄ±sÄ±nÄ±z.</td></tr>`;
            return;
        }

        try {
            const response = await fetch(`https://unity-choice-api-production-8a70.up.railway.app/api/user-report/${username}`);
            const data = await response.json();
            raporlarTableBody.innerHTML = "";

            if (response.ok && data.reportLink) {
                const tr = document.createElement("tr");
                const formattedDate = data.generatedAt ? new Date(data.generatedAt).toLocaleDateString("tr-TR") : "--";
                tr.innerHTML = `
                    <td>Psikolojik DeÄŸerlendirme Raporu</td>
                    <td>${formattedDate}</td>
                    <td>
                        <a href="${data.reportLink}" target="_blank" class="btn btn-sm btn-outline-primary" id="view">GÃ¶rÃ¼ntÃ¼le</a>
                        <a href="${data.reportLink}?download=rapor.pdf" class="btn btn-sm btn-outline-danger" id="download">Ä°ndir</a>
                    </td>
                `;
                raporlarTableBody.appendChild(tr);
            } else {
                raporlarTableBody.innerHTML = `<tr><td colspan="3">Rapor bulunamadÄ±.</td></tr>`;
            }
        } catch (err) {
            console.error("Rapor yÃ¼kleme hatasÄ±:", err);
            raporlarTableBody.innerHTML = `<tr><td colspan="3">Sunucu hatasÄ±.</td></tr>`;
        }
    }

    // Dashboard Rapor AlanÄ±nÄ± Doldurma (anasayfa iÃ§in)
    async function loadDashboardReports() {
        const reportsContainer = document.getElementById("latest-reports");
        const username = localStorage.getItem("username");
        if (!username) {
            reportsContainer.innerHTML = `<div class="alert alert-warning">GiriÅŸ yapmadan rapor gÃ¶rÃ¼ntÃ¼lenemez.</div>`;
            return;
        }

        try {
            const response = await fetch(`https://unity-choice-api-production-8a70.up.railway.app/api/user-report/${username}`);
            const data = await response.json();

            if (response.ok && data.reportLink) {
                reportsContainer.innerHTML = `
                    <div class="list-group-item d-flex align-items-center p-2">
                        <div class="flex-fill" style="margin-left: 10px;">
                            <div class="small">Psikolojik DeÄŸerlendirme Raporu</div>
                        </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="window.open('${data.reportLink}', '_blank')" id="view">
                            GÃ¶rÃ¼ntÃ¼le
                        </button>
                    </div>
                `;
            } else {
                reportsContainer.innerHTML = `<div class="alert alert-info">HenÃ¼z rapor bulunmamaktadÄ±r.</div>`;
            }
        } catch (err) {
            reportsContainer.innerHTML = `<div class="alert alert-danger">Sunucu ile iletiÅŸim kurulamadÄ±.</div>`;
        }
    }

    // Sayfa yÃ¼klenince dashboard raporlarÄ±nÄ± ve grafikleri yÃ¼kle
    loadDashboardReports();
/*
    // ==========================================================
    // ANALÄ°ZLERÄ°N GRAFÄ°KLERÄ°
    // ==========================================================
    // IPIP KiÅŸilik Ã–zellikleri GrafiÄŸi
    const ipipCtx = document.getElementById("ipipChart").getContext("2d");
    const ipipChart = new Chart(ipipCtx, {
        type: "bar",
        data: {
            labels: ["Nevrotiklik", "DÄ±ÅŸadÃ¶nÃ¼klÃ¼k", "AÃ§Ä±klÄ±k", "Uyumluluk", "VicdanlÄ±lÄ±k"],
            datasets: [{
                label: "Seviye (%)",
                data: [68, 42, 55, 76, 63],
                backgroundColor: ["rgba(231, 74, 59, 0.7)", "rgba(78, 115, 223, 0.7)", "rgba(246, 194, 62, 0.7)", "rgba(28, 200, 138, 0.7)", "rgba(54, 185, 204, 0.7)"],
                borderColor: ["rgba(231, 74, 59, 1)", "rgba(78, 115, 223, 1)", "rgba(246, 194, 62, 1)", "rgba(28, 200, 138, 1)", "rgba(54, 185, 204, 1)"],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function (value) { return value + "%"; }
                    }
                }
            },
            plugins: { legend: { display: false } }
        }
    });

    // GAD-7 Anksiyete GrafiÄŸi
    const gad7Ctx = document.getElementById("gad7Chart").getContext("2d");
    const gad7Chart = new Chart(gad7Ctx, {
        type: "doughnut",
        data: {
            labels: ["Hafif", "Orta", "Åžiddetli"],
            datasets: [{
                data: [30, 50, 20],
                backgroundColor: ["rgba(28, 200, 138, 0.7)", "rgba(246, 194, 62, 0.7)", "rgba(231, 74, 59, 0.7)"],
                borderColor: ["rgba(28, 200, 138, 1)", "rgba(246, 194, 62, 1)", "rgba(231, 74, 59, 1)"],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: "70%",
            plugins: { legend: { position: "bottom" } }
        }
    });

    // Kariyer Ã–nerileri Radar GrafiÄŸi
    const careerCtx = document.getElementById("careerChart").getContext("2d");
    const careerChart = new Chart(careerCtx, {
        type: "radar",
        data: {
            labels: ["Sosyal Beceri", "Analitik DÃ¼ÅŸÃ¼nce", "YaratÄ±cÄ±lÄ±k", "Liderlik", "Empati"],
            datasets: [{
                label: "Mevcut Seviye",
                data: [75, 60, 55, 50, 80],
                backgroundColor: "rgba(78, 115, 223, 0.2)",
                borderColor: "rgba(78, 115, 223, 1)",
                pointBackgroundColor: "rgba(78, 115, 223, 1)",
                pointBorderColor: "#fff",
                pointHoverBackgroundColor: "#fff",
                pointHoverBorderColor: "rgba(78, 115, 223, 1)"
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: { angleLines: { display: true }, suggestedMin: 0, suggestedMax: 100 }
            }
        }
    });

    // === GRAFÄ°KLERÄ° GÃœNCELLEME FONKSÄ°YONU ===
    function updateDashboardVisuals(scores) {
        if (!scores) return;
    
        // Her bir Ã¶zellik iÃ§in ID'leri ve skorlarÄ± eÅŸleÅŸtirerek gÃ¼ncelle
        const chartMapping = {
            disadonukluk: { barId: 'bar-disadonukluk', textId: 'text-disadonukluk', label: 'DÄ±ÅŸadÃ¶nÃ¼klÃ¼k' },
            uyumluluk: { barId: 'bar-uyumluluk', textId: 'text-uyumluluk', label: 'Uyumluluk' },
            sorumluluk: { barId: 'bar-sorumluluk', textId: 'text-sorumluluk', label: 'Sorumluluk' },
            duygusalDenge: { barId: 'bar-duygusaldenge', textId: 'text-duygusaldenge', label: 'Duygusal Denge' }
        };
    
        // n8n'den gelen skorlar nesnesindeki her bir anahtar iÃ§in dÃ¶ngÃ¼ baÅŸlat
        for (const key in scores) {
            if (chartMapping[key]) {
                const mapping = chartMapping[key];
                const score = scores[key]; // Ã–rneÄŸin, scores['disadonukluk'] -> 75
                
                const barElement = document.getElementById(mapping.barId);
                const textElement = document.getElementById(mapping.textId);
    
                // Ä°lgili HTML elementleri bulunduysa gÃ¼ncelle
                if (barElement && textElement) {
                    barElement.style.width = `${score}%`;
                    barElement.setAttribute('aria-valuenow', score);
                    textElement.textContent = `${mapping.label}: %${score}`;
                }
            }
        }
    }
*/

    // ==========================================================
        // DEÄžÄ°ÅžKENLER VE CHART.JS NESNELERÄ°
        // ==========================================================
        let ipipChart, gad7Chart, careerChart; // Grafikleri globalde tanÄ±mlayalÄ±m ki gÃ¼ncelleyebilelim

        // ==========================================================
        // ANA FONKSÄ°YONLAR
        // ==========================================================

        async function fetchReportData() {
            const userId = localStorage.getItem("userId");
            if (!userId) {
                console.warn("KullanÄ±cÄ± ID bulunamadÄ±.");
                return null;
            }
            try {
                const response = await fetch("/.netlify/functions/get-analysis-data", { // Tek bir fonksiyon kullanÄ±yoruz
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ userId: userId })
                });
                const data = await response.json();
                return (response.ok && data.success) ? data : null;
            } catch (err) {
                console.error("Rapor verisi yÃ¼klenemedi:", err);
                return null;
            }
        }

        function updateAllVisuals(report) {
            if (!report) return;
            // Dashboard'daki progress barlarÄ± gÃ¼ncelle
            updateDashboardProgressBars(report.scores);
            // Analizler sekmesindeki Chart.js grafiklerini gÃ¼ncelle
            updateAnalysisCharts(report.scores);
            // Analizler sekmesindeki AI yorumunu gÃ¼ncelle
            updateAiComment(report.aiComment);
        }

        function updateDashboardProgressBars(scores) {
            if (!scores) return;
            const chartMapping = {
                disadonukluk: { barId: 'bar-disadonukluk', textId: 'text-disadonukluk', label: 'DÄ±ÅŸadÃ¶nÃ¼klÃ¼k' },
                uyumluluk: { barId: 'bar-uyumluluk', textId: 'text-uyumluluk', label: 'Uyumluluk' },
                sorumluluk: { barId: 'bar-sorumluluk', textId: 'text-sorumluluk', label: 'Sorumluluk' },
                duygusalDenge: { barId: 'bar-duygusaldenge', textId: 'text-duygusaldenge', label: 'Duygusal Denge' }
            };
            for (const key in scores) {
                if (chartMapping[key]) {
                    const mapping = chartMapping[key];
                    const score = scores[key];
                    const barElement = document.getElementById(mapping.barId);
                    const textElement = document.getElementById(mapping.textId);
                    if (barElement && textElement) {
                        barElement.style.width = `${score}%`;
                        textElement.textContent = `${mapping.label}: %${score}`;
                    }
                }
            }
        }
        
        function updateAnalysisCharts(scores) {
            if (!scores || !ipipChart || !gad7Chart || !careerChart) return;
            // IPIP Bar GrafiÄŸini GÃ¼ncelle
            ipipChart.data.datasets[0].data = [
                scores.nevrotiklik,
                scores.disadonukluk,
                scores.aciklik,
                scores.uyumluluk,
                scores.vicdanlilik
            ];
            ipipChart.update();

            // GAD-7 Donut GrafiÄŸini GÃ¼ncelle (GAD-7 skoruna gÃ¶re yorumlayalÄ±m)
            let gad7Data = [0, 0, 0]; // [hafif, orta, ÅŸiddetli]
            if (scores.gad7 >= 5 && scores.gad7 <= 9) gad7Data[0] = 100;
            else if (scores.gad7 >= 10 && scores.gad7 <= 14) gad7Data[1] = 100;
            else if (scores.gad7 >= 15) gad7Data[2] = 100;
            gad7Chart.data.datasets[0].data = gad7Data;
            gad7Chart.update();

            // Kariyer Radar GrafiÄŸini GÃ¼ncelle (IPIP skorlarÄ±ndan ilgili olanlarÄ± alalÄ±m)
            careerChart.data.datasets[0].data = [
                scores.uyumluluk,      // Sosyal Beceri (Uyumluluk varsayÄ±mÄ±)
                scores.sorumluluk,     // Analitik DÃ¼ÅŸÃ¼nce (Sorumluluk varsayÄ±mÄ±)
                scores.aciklik,        // YaratÄ±cÄ±lÄ±k (AÃ§Ä±klÄ±k varsayÄ±mÄ±)
                scores.disadonukluk,   // Liderlik (DÄ±ÅŸadÃ¶nÃ¼klÃ¼k varsayÄ±mÄ±)
                scores.uyumluluk       // Empati (Uyumluluk varsayÄ±mÄ±)
            ];
            careerChart.update();
        }

        function updateAiComment(comment) {
            const aiCommentEl = document.getElementById("aiComment");
            if (aiCommentEl) {
                aiCommentEl.textContent = comment ? `"${comment}"` : "Yapay zeka yorumu henÃ¼z mevcut deÄŸil.";
            }
        }

    // Sayfa yÃ¼klenince ilk iÅŸ olarak verileri yÃ¼kle
        async function initializePage() {
            const data = await fetchReportData();
            initializeCharts(); // Ã–nce boÅŸ grafikleri Ã§iz
            updateAllVisuals(data?.report); // Sonra gelen veriyle gÃ¼ncelle
        }

        function initializeCharts() {
            // IPIP GrafiÄŸi
            const ipipCtx = document.getElementById("ipipChart").getContext("2d");
            ipipChart = new Chart(ipipCtx, {
                type: "bar",
                data: {
                    labels: ["Nevrotiklik", "DÄ±ÅŸadÃ¶nÃ¼klÃ¼k", "AÃ§Ä±klÄ±k", "Uyumluluk", "Sorumluluk"],
                    datasets: [{
                        label: "Seviye (%)",
                        data: [0, 0, 0, 0, 0], // BaÅŸlangÄ±Ã§ta boÅŸ
                        backgroundColor: ["rgba(231, 74, 59, 0.7)", "rgba(78, 115, 223, 0.7)", "rgba(246, 194, 62, 0.7)", "rgba(28, 200, 138, 0.7)", "rgba(54, 185, 204, 0.7)"],
                    }]
                },
                options: { scales: { y: { beginAtZero: true, max: 100 } }, plugins: { legend: { display: false } } }
            });

            // GAD-7 GrafiÄŸi
            const gad7Ctx = document.getElementById("gad7Chart").getContext("2d");
            gad7Chart = new Chart(gad7Ctx, {
                type: "doughnut",
                data: {
                    labels: ["Hafif", "Orta", "Åžiddetli"],
                    datasets: [{ data: [0, 0, 0], backgroundColor: ["#1cc88a", "#f6c23e", "#e74a3b"] }]
                },
                options: { cutout: "70%", plugins: { legend: { position: "bottom" } } }
            });

            // Kariyer GrafiÄŸi
            const careerCtx = document.getElementById("careerChart").getContext("2d");
            careerChart = new Chart(careerCtx, {
                type: "radar",
                data: {
                    labels: ["Sosyal Beceri", "Analitik DÃ¼ÅŸÃ¼nce", "YaratÄ±cÄ±lÄ±k", "Liderlik", "Empati"],
                    datasets: [{
                        label: "Mevcut Seviye",
                        data: [0, 0, 0, 0, 0], // BaÅŸlangÄ±Ã§ta boÅŸ
                        backgroundColor: "rgba(78, 115, 223, 0.2)",
                        borderColor: "rgba(78, 115, 223, 1)",
                    }]
                },
                options: { scales: { r: { suggestedMin: 0, suggestedMax: 100 } } }
            });
        }
    initializePage();



});
</script>
</body>
</html>
