<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Giriş ve Kayıt</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="Giriş.css" />
</head>
<body>
    <div class="logo">
      <i class="fas fa-graduation-cap"></i>
      <span>KutAI</span>
    </div>

    <div class="main">
      <div class="user-type-selector" id="user-type-selector">
        <button class="user-type-btn active" id="student-btn">
          <i class="fas fa-user-graduate"></i> Öğrenci
        </button>
        <button class="user-type-btn" id="teacher-btn">
          <i class="fas fa-chalkboard-teacher"></i> Öğretmen
        </button>
      </div>

      <input type="checkbox" id="chk" aria-hidden="true" />
      <input type="checkbox" id="forgot-chk" aria-hidden="true" />

      <div class="signup">
        <form id="register-form">
          <label> <i class="fas fa-user-plus"></i> Öğrenci Kaydı </label>

          <div id="register-message" class="message-box"></div>

          <div class="input-group">
            <i class="fas fa-user input-icon"></i>
            <input
              type="text"
              name="name"
              placeholder=" "
              required
              id="register-name"
            />
            <span class="floating-label">Adınız</span>
          </div>

          <div class="input-group">
            <i class="fas fa-user input-icon"></i>
            <input
              type="text"
              name="surname"
              placeholder=" "
              required
              id="register-surname"
            />
            <span class="floating-label">Soyadınız</span>
          </div>

          <div class="input-group">
            <i class="fas fa-envelope input-icon"></i>
            <input
              type="email"
              name="email"
              placeholder=" "
              required
              id="register-email"
            />
            <span class="floating-label">Emailiniz</span>
          </div>

          <div class="input-group">
            <i class="fas fa-at input-icon"></i>
            <input
              type="text"
              name="username"
              placeholder=" "
              required
              id="register-username"
            />
            <span class="floating-label">Kullanıcı Adınız</span>
          </div>

          <div class="input-group">
            <i class="fas fa-lock input-icon"></i>
            <div class="password-container">
              <input
                type="password"
                id="registerPassword"
                name="password"
                placeholder=" "
                required
              />
              <span class="floating-label">Şifre</span>
              <span
                class="eye-icon"
                onclick="togglePasswordVisibility('registerPassword', this)"
              >
                <i class="far fa-eye"></i>
              </span>
            </div>
          </div>

          <button type="submit" id="register-button">
            <i class="fas fa-user-plus"></i> Kayıt Ol
          </button>

          <div class="divider">
            <div class="divider-line"></div>
            <div class="divider-text">veya</div>
            <div class="divider-line"></div>
          </div>

          <p class="info-text">
            Hesabınız var mı? <a onclick="toggleForm()">Giriş yapın</a>
          </p>
          
          <p class="info-text">
            Öğretmen misiniz? <a id="teacher-info-link" onclick="toggleTeacherOverlay()">Bilgi alın</a>
          </p>
        </form>
      </div>

      <div class="login">
        <form id="login-form">
          <label> <i class="fas fa-sign-in-alt"></i> Öğrenci Girişi </label>
          <!-- Giriş formu için mesaj kutusu -->
          <div id="login-message" class="message-box"></div>

          <div class="input-group">
            <i class="fas fa-at input-icon"></i>
            <input
              type="text"
              name="username"
              placeholder=" "
              required
              id="login-username"
            />
            <span class="floating-label">Kullanıcı Adı</span>
          </div>

          <div class="input-group">
            <i class="fas fa-lock input-icon"></i>
            <div class="password-container">
              <input
                type="password"
                id="loginPassword"
                name="pswd"
                placeholder=" "
                required
              />
              <span class="floating-label">Şifre</span>
              <span
                class="eye-icon"
                onclick="togglePasswordVisibility('loginPassword', this)"
              >
                <i class="far fa-eye"></i>
              </span>
            </div>
          </div>

          <button type="submit" id="login-button">
            <i class="fas fa-sign-in-alt"></i> Giriş Yap
          </button>

          <div class="forgot-link">
            <a onclick="toggleForgotPassword()">Şifremi unuttum</a>
          </div>

          <div class="divider">
            <div class="divider-line"></div>
            <div class="divider-text">veya</div>
            <div class="divider-line"></div>
          </div>

          <p class="info-text">
            Hesabınız yok mu? <a onclick="toggleForm()">Kayıt olun</a>
          </p>
        </form>
      </div>

      <div class="forgot-password">
        <form id="forgot-password-form">
          <label> <i class="fas fa-key"></i> Şifremi Unuttum </label>

          <div id="forgot-message" class="message-box"></div>

          <div class="input-group">
            <i class="fas fa-envelope input-icon"></i>
            <input
              type="email"
              name="email"
              placeholder=" "
              required
              id="forgot-email"
            />
            <span class="floating-label">Email Adresiniz</span>
          </div>

          <button type="submit" id="forgot-button">
            <i class="fas fa-paper-plane"></i> Şifre Sıfırlama Maili Gönder
          </button>

          <div class="divider">
            <div class="divider-line"></div>
            <div class="divider-text">veya</div>
            <div class="divider-line"></div>
          </div>

          <p class="info-text">
            <a onclick="toggleBackToLogin()">Giriş sayfasına dön</a>
          </p>
        </form>
      </div>
    </div>

    <!-- ÖĞRETMEN OVERLAY -->
<div id="teacher-overlay" class="overlay">
  <div id="teacher-container" class="p-4">
    <div class="teacher-content bg-white rounded-4 shadow-lg p-5">
      
      <!-- Başlık -->
      <span class="badge bg-danger px-3 py-2 fs-6 mb-3">Öğretmen Bilgilendirme</span>
      <h2 class="story-title fw-bold mb-2">Öğretmen Kayıt Süreci</h2>
      <div class="border-bottom border-danger border-3 mb-4" style="width: 60px"></div>
      
      <!-- Açıklama -->
      <div class="story-section mb-4">
        <p class="lead fw-semibold">
          Öğretmen olanların güvenliği için <strong>okulları ya da bireysel olarak</strong> bizimle direkt olarak iletişime geçerek hesap açmaları gerekmektedir.
        </p>
      </div>
      
      <!-- Alıntı -->
      <div class="highlight bg-light p-4 rounded-3 mb-5 shadow-sm">
        <div class="d-flex">
          <i class="bi bi-quote fs-1 text-danger opacity-25 me-3"></i>
          <div>
            <blockquote class="mb-0 fst-italic fw-semibold">
              "Eğitimde güvenlik her şeyden önce gelir. Öğretmen hesaplarının güvenliği için ek önlemler alınmaktadır."
            </blockquote>
          </div>
        </div>
      </div>
      
      <!-- Liste -->
      <ul class="list-unstyled mt-3">
        <li class="mb-4">
          <div class="d-flex align-items-start">
           
            <div>
              <span class="badge bg-danger mb-1">  <i class="bi bi-shield-check text-danger fs-4 me-3 mt-1"></i> Güvenlik Önlemleri</span>
              <p class="fw-semibold mb-0">Öğretmen hesapları ek güvenlik önlemleri ile korunmaktadır.</p>
              <p class="text-muted small">Hesap açma süreci manuel olarak kontrol edilmektedir.</p>
            </div>
          </div>
        </li>
        
        <li class="mb-4">
          <div class="d-flex align-items-start">
          
            <div>
              <span class="badge bg-danger mb-1">  <i class="bi bi-envelope text-danger fs-4 me-3 mt-1"></i> İletişim Süreci</span>
              <p class="fw-semibold mb-0">Öğretmen kaydı için aşağıdaki e-posta adresine okul bilgilerinizi iletmeniz gerekmektedir.</p>
              <p class="text-muted small">Okul adı, göreviniz ve iletişim bilgileriniz belirtilmelidir.</p>
            </div>
          </div>
        </li>
        
        <li class="mb-4">
          <div class="d-flex align-items-start">
     
            <div>
              <span class="badge bg-danger mb-1">  <i class="bi bi-clock-history text-danger fs-4 me-3 mt-1"></i> İşlem Süresi</span>
              <p class="fw-semibold mb-0">İletişime geçtikten sonra hesabınızın açılması <strong>1-3 iş günü</strong> sürebilir.</p>
              <p class="text-muted small">Onay sürecinden sonra giriş bilgileriniz e-posta ile iletilecektir.</p>
            </div>
          </div>
        </li>
      </ul>
      
      <!-- Uyarı -->
      <div class="alert alert-danger mt-5 d-flex align-items-center shadow-sm">
        <i class="bi bi-exclamation-triangle-fill fs-3 me-3"></i>
        <div class="fw-semibold">
          <strong>İletişim Bilgisi:</strong> Öğretmen kaydı için lütfen 
          <span class="fw-bold">tulpar.kutai@kutai.com</span> adresine e-posta gönderiniz.
        </div>
      </div>
      
      <!-- Kapat Butonu -->
      <button id="teacher-close-btn" class="btn btn-danger btn-lg w-100 mt-4 rounded-pill fw-bold">
        <i class="bi bi-x-circle-fill me-2"></i> Pencereyi Kapat
      </button>
      
    </div>
  </div>
</div>

    <script>
      function togglePasswordVisibility(fieldId, iconElement) {
        const passwordField = document.getElementById(fieldId);
        if (passwordField) {
          const isPassword = passwordField.type === "password";
          passwordField.type = isPassword ? "text" : "password";

          const icon = iconElement.querySelector("i");
          if (isPassword) {
            icon.classList.remove("fa-eye");
            icon.classList.add("fa-eye-slash");
          } else {
            icon.classList.remove("fa-eye-slash");
            icon.classList.add("fa-eye");
          }
        }
      }

      // Mesaj gösterme fonksiyonu
      function showMessage(elementId, message, type) {
        const messageBox = document.getElementById(elementId);
        if (messageBox) {
          messageBox.innerHTML = ""; // Önceki içeriği temizle
          messageBox.className = "message-box"; // Tüm sınıfları sıfırla

          let iconClass = "";
          if (type === "success") {
            messageBox.classList.add("success");
            iconClass = "fas fa-check-circle";
          } else if (type === "error") {
            messageBox.classList.add("error");
            iconClass = "fas fa-exclamation-circle";
          }

          if (message) {
            // Sadece mesaj varsa içeriği ve ikonları göster
            messageBox.innerHTML = `<i class="${iconClass}"></i> ${message}`;
            messageBox.classList.add("show");

            // Başarılı mesajları yönlendirmeden önce görmek için
            if (type === "success") {
              setTimeout(() => {
                messageBox.classList.remove("show");
              }, 2000); // 2 saniye sonra gizle
            } else {
              // Hata mesajlarını 5 saniye sonra gizle
              setTimeout(() => {
                messageBox.classList.remove("show");
              }, 5000);
            }
          } else {
            // Mesaj boşsa gizle
            messageBox.classList.remove("show");
          }
        }
      }

      function toggleForm(toLogin = false) {
        const chk = document.getElementById("chk");
        const forgotChk = document.getElementById("forgot-chk");
        
        // Şifremi unuttum formunu kapat
        forgotChk.checked = false;
        
        // Eğer toLogin true ise, giriş formunu göster (checked=false yap)
        // Değilse mevcut davranışı uygula (toggle)
        if (toLogin === true) {
          chk.checked = false;
        } else {
          chk.checked = !chk.checked;
        }

        const event = new Event("change");
        chk.dispatchEvent(event);
        forgotChk.dispatchEvent(event);

        // Form değiştirildiğinde mesaj kutularını temizle
        showMessage("register-message", "", "");
        showMessage("login-message", "", "");
        showMessage("forgot-message", "", "");
        
        // Ana yüksekliği ayarla
        adjustMainHeight();
      }
      
      function toggleForgotPassword() {
        const chk = document.getElementById("chk");
        const forgotChk = document.getElementById("forgot-chk");
        
        chk.checked = false;
        forgotChk.checked = true;
        
        const event = new Event("change");
        chk.dispatchEvent(event);
        forgotChk.dispatchEvent(event);
        
        // Mesaj kutularını temizle
        showMessage("register-message", "", "");
        showMessage("login-message", "", "");
        showMessage("forgot-message", "", "");
        
        // Ana yüksekliği ayarla
        adjustMainHeight();
      }
      
      function toggleBackToLogin() {
        const chk = document.getElementById("chk");
        const forgotChk = document.getElementById("forgot-chk");
        
        chk.checked = false;
        forgotChk.checked = false;
        
        const event = new Event("change");
        chk.dispatchEvent(event);
        forgotChk.dispatchEvent(event);
        
        // Mesaj kutularını temizle
        showMessage("register-message", "", "");
        showMessage("login-message", "", "");
        showMessage("forgot-message", "", "");
        
        // Ana yüksekliği ayarla
        adjustMainHeight();
      }
      
      function toggleTeacherOverlay() {
        const teacherOverlay = document.getElementById("teacher-overlay");
        teacherOverlay.classList.toggle("active");
      }
      
      function adjustMainHeight() {
        const mainContainer = document.querySelector(".main");
        const chk = document.getElementById("chk");
        const forgotChk = document.getElementById("forgot-chk");
        
        if (forgotChk.checked) {
          // Şifremi unuttum formu aktif
          mainContainer.style.height = "450px";
        } else if (chk.checked) {
          // Kayıt formu aktifse yüksekliği artır
          mainContainer.style.height = "750px";
        } else {
          // Giriş formu aktifse yüksekliği azalt
          mainContainer.style.height = "540px";
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        const studentBtn = document.getElementById("student-btn");
        const teacherBtn = document.getElementById("teacher-btn");
        const userTypeSelector = document.getElementById("user-type-selector");
        const teacherOverlay = document.getElementById("teacher-overlay");
        const teacherCloseBtn = document.getElementById("teacher-close-btn");

        const chk = document.getElementById("chk");
        const forgotChk = document.getElementById("forgot-chk");
        const mainContainer = document.querySelector(".main");

        // Öğretmen overlay kapatma
        if (teacherCloseBtn) {
          teacherCloseBtn.addEventListener("click", function() {
            teacherOverlay.classList.remove("active");
          });
        }

        // Overlay dışına tıklanınca kapat
        teacherOverlay.addEventListener("click", function(e) {
          if (e.target === teacherOverlay) {
            teacherOverlay.classList.remove("active");
          }
        });

        chk.addEventListener("change", function () {
          // Kayıt formu açıldığında sadece öğrenci seçeneğini göster
          if (this.checked) {
            userTypeSelector.style.width = "200px";
            teacherBtn.style.display = "none";
            studentBtn.style.flex = "1";
          } else {
            userTypeSelector.style.width = "90%";
            teacherBtn.style.display = "flex";
          }
          
          adjustMainHeight();
          // Form değişiminde mesajları temizle
          showMessage("register-message", "", "");
          showMessage("login-message", "", "");
          showMessage("forgot-message", "", "");
        });
        
        forgotChk.addEventListener("change", function () {
          adjustMainHeight();
          // Form değişiminde mesajları temizle
          showMessage("register-message", "", "");
          showMessage("login-message", "", "");
          showMessage("forgot-message", "", "");
        });

        studentBtn.addEventListener("click", function () {
          studentBtn.classList.add("active");
          teacherBtn.classList.remove("active");
          document.querySelectorAll("form label").forEach((label) => {
            if (label.querySelector("i").classList.contains("fa-sign-in-alt")) {
              label.innerHTML =
                '<i class="fas fa-sign-in-alt"></i> Öğrenci Girişi';
            } else if (label.querySelector("i").classList.contains("fa-user-plus")) {
              label.innerHTML =
                '<i class="fas fa-user-plus"></i> Öğrenci Kaydı';
            } else if (label.querySelector("i").classList.contains("fa-key")) {
              label.innerHTML =
                '<i class="fas fa-key"></i> Şifremi Unuttum';
            }
          });
          showMessage("register-message", "", "");
          showMessage("login-message", "", "");
          showMessage("forgot-message", "", "");
        });

        teacherBtn.addEventListener("click", function () {
          teacherBtn.classList.add("active");
          studentBtn.classList.remove("active");
          document.querySelectorAll("form label").forEach((label) => {
            if (label.querySelector("i").classList.contains("fa-sign-in-alt")) {
              label.innerHTML =
                '<i class="fas fa-sign-in-alt"></i> Öğretmen Girişi';
            } else if (label.querySelector("i").classList.contains("fa-user-plus")) {
              label.innerHTML =
                '<i class="fas fa-user-plus"></i> Öğretmen Kaydı';
            } else if (label.querySelector("i").classList.contains("fa-key")) {
              label.innerHTML =
                '<i class="fas fa-key"></i> Şifremi Unuttum';
            }
          });
          showMessage("register-message", "", "");
          showMessage("login-message", "", "");
          showMessage("forgot-message", "", "");
        });

        const registerForm = document.getElementById("register-form");
        if (registerForm) {
          registerForm.addEventListener("submit", async function (event) {
            event.preventDefault();
            const registerButton = document.getElementById("register-button");
            registerButton.disabled = true;
            registerButton.innerHTML =
              '<i class="fas fa-spinner fa-spin"></i> Kaydediliyor...';

            // Önceki mesajları temizle
            showMessage("register-message", "", "");

            try {
              const formData = {
                name: document.getElementById("register-name").value,
                surname: document.getElementById("register-surname").value,
                email: document.getElementById("register-email").value,
                username: document.getElementById("register-username").value,
                password: document.getElementById("registerPassword").value,
                userType: studentBtn.classList.contains("active")
                  ? "student"
                  : "teacher",
              };

              const response = await fetch("/.netlify/functions/register", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(formData),
              });

              const result = await response.json();
              if (response.ok) {
                showMessage(
                  "register-message",
                  result.message || "Kayıt başarılı!",
                  "success"
                );

                registerForm.reset();

                setTimeout(() => {
                  toggleForm(true);
                }, 2000);
              } else {
                showMessage(
                  "register-message",
                  result.message || "Bilinmeyen bir hata oluştu.",
                  "error"
                );
              }
            } catch (error) {
              console.error("Kayıt sırasında hata:", error);
              showMessage(
                "register-message",
                "Bir ağ hatası oluştu. Lütfen tekrar deneyin.",
                "error"
              );
            } finally {
              registerButton.disabled = false;
              registerButton.innerHTML =
                '<i class="fas fa-user-plus"></i> Kayıt Ol';
            }
          });
        }

        const loginForm = document.getElementById("login-form");
        if (loginForm) {
          loginForm.addEventListener("submit", async function (event) {
            event.preventDefault();

            const loginButton = document.getElementById("login-button");
            loginButton.disabled = true;
            loginButton.innerHTML =
              '<i class="fas fa-spinner fa-spin"></i> Giriş Yapılıyor...';

            // Önceki mesajları temizle
            showMessage("login-message", "", "");

            try {
              const loginData = {
                username: document.getElementById("login-username").value,
                password: document.getElementById("loginPassword").value,
                userType: studentBtn.classList.contains("active")
                  ? "student"
                  : "teacher",
              };

              const response = await fetch("/.netlify/functions/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(loginData),
              });

              // Yanıtı JSON olarak parse etmeye çalış
              let result;
              try {
                result = await response.json();
              } catch (e) {
                throw new Error("Sunucudan geçersiz yanıt alındı.");
              }
              if (response.ok && result.token) {
                localStorage.setItem("userToken", result.token);
                localStorage.setItem("userId", result.userId);
                localStorage.setItem("username", loginData.username);
                localStorage.setItem("userEmail", result.email);
                localStorage.setItem("userType", loginData.userType);

                showMessage(
                  "login-message",
                  result.message || "Giriş başarılı!",
                  "success"
                );

                setTimeout(() => {
                  if (loginData.userType === "student") {
                    window.location.href = "main.html";
                  } else if (loginData.userType === "teacher") {
                    window.location.href = "OgretmenSayfa.html";
                  } else {
                    window.location.href = "index.html";
                  }
                }, 2000);
              } else {
                // Giriş başarısızsa yönlendirme YAPMA, sadece hata göster
                showMessage(
                  "login-message",
                  result.message || "Kullanıcı adı veya şifre hatalı.",
                  "error"
                );
              }
            } catch (error) {
              console.error("HATA:", error);
              showMessage(
                "login-message",
                error.message || "Bir ağ hatası oluştu. Lütfen tekrar deneyin.",
                "error"
              );
            } finally {
              loginButton.disabled = false;
              loginButton.innerHTML =
                '<i class="fas fa-sign-in-alt"></i> Giriş Yap';
            }
          });
        }
        
        // Şifremi unuttum formu işleme
        const forgotForm = document.getElementById("forgot-password-form");
        if (forgotForm) {
          forgotForm.addEventListener("submit", async function (event) {
            event.preventDefault();
            const forgotButton = document.getElementById("forgot-button");
            forgotButton.disabled = true;
            forgotButton.innerHTML =
              '<i class="fas fa-spinner fa-spin"></i> Gönderiliyor...';

            // Önceki mesajları temizle
            showMessage("forgot-message", "", "");

            try {
              const email = document.getElementById("forgot-email").value;
              const userType = studentBtn.classList.contains("active")
                ? "student"
                : "teacher";

              const response = await fetch("/.netlify/functions/forgot-password", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email, userType }),
              });

              const result = await response.json();
              if (response.ok) {
                showMessage(
                  "forgot-message",
                  result.message || "Şifre sıfırlama maili gönderildi!",
                  "success"
                );

                forgotForm.reset();

                setTimeout(() => {
                  toggleBackToLogin();
                }, 2000);
              } else {
                showMessage(
                  "forgot-message",
                  result.message || "Bu email adresi ile kayıtlı kullanıcı bulunamadı.",
                  "error"
                );
              }
            } catch (error) {
              console.error("Şifre sıfırlama sırasında hata:", error);
              showMessage(
                "forgot-message",
                "Bir ağ hatası oluştu. Lütfen tekrar deneyin.",
                "error"
              );
            } finally {
              forgotButton.disabled = false;
              forgotButton.innerHTML =
                '<i class="fas fa-paper-plane"></i> Şifre Sıfırlama Maili Gönder';
            }
          });
        }
        
        // Sayfa yüklendiğinde yüksekliği ayarla
        adjustMainHeight();
      });
    </script>
</body>
</html>