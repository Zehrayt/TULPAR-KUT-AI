<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kullanıcı Paneli</title>
    <link rel="stylesheet" href="KullanıcıSayfa.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <script>
      if (!localStorage.getItem('userToken')) {
        alert('Bu sayfayı görüntülemek için lütfen giriş yapın.');
        window.location.href = 'index.html'; 
      }
    </script>
  </head>

  <body class="bg-light-custom">
    <div style="font-size: 17px">
      <nav
        class="navbar navbar-expand-lg bg-light  position-relative py-2 font height:10vh shadow-sm "
      >
        <div class="container-fluid">
          <a class="navbar-brand" href="main.html">Kut-AI</a>
          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navbarMain"
          >
            <span class="navbar-toggler-icon"></span>
          </button>


          <div class="d-flex gap-2 navbar-right">
            <div class="dropdown">
              <button class="btn btn-outline-primary dropdown-toggle rounded-5 px-3 " type="button" id="dropdownMenuButton" data-bs-toggle="dropdown">
                <i class="bi bi-person-circle me-1"  style="z-index: +1;"></i>Gözde Gönül
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#">Profil</a></li>
                <li><a class="dropdown-item" href="#">Ayarlar</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-danger" href="index.html" id="logout-link">Çıkış Yap</a></li>
              </ul>
            </div>
          </div>
        </div>
      </nav>
    </div>

    <div class="container-fluid py-4">
      <div class="row">
        <!-- Sidebar -->
        <div class="col-lg-3 d-none d-lg-block">
          <div class="card shadow-sm rounded-3 border-0 mb-4">
            <div class="card-body text-center py-4">
             <h5 class="mb-1 user-name-display">Gözde Gönül</h5>
              <p class="text-muted small user-email-display">gozde.gonul@example.com</p>
              <div class="d-flex justify-content-center gap-2 mt-3">
                <span class="badge bg-success">Aktif</span>
              </div>
            </div>
          </div>
          
          <div class="card shadow-sm rounded-3 border-0">
            <div class="card-body">
              <h6 class="fw-bold mb-3">Psikolojik Durum Analizi</h6>
              <div class="progress mb-2" style="height: 8px;">
                <div class="progress-bar bg-danger" role="progressbar" style="width: 25%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <p class="small text-muted mb-3">Dışadönüklük: %25</p>
              
              <div class="progress mb-2" style="height: 8px;">
                <div class="progress-bar bg-warning" role="progressbar" style="width: 50%;" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <p class="small text-muted mb-3">Uyumluluk: %50</p>
              
              <div class="progress mb-2" style="height: 8px;">
                <div class="progress-bar bg-info" role="progressbar" style="width: 75%;" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <p class="small text-muted mb-3">Sorumluluk: %75</p>
              
              <div class="progress mb-2" style="height: 8px;">
                <div class="progress-bar bg-success" role="progressbar" style="width: 60%;" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <p class="small text-muted">Duygusal Denge: %60</p>
            </div>
          </div>
        </div>
        
        <!-- Main Content -->
        <div class="col-lg-9">
          <div class="card shadow-sm rounded-3 border-0 mb-4">
            <div class="card-body p-0">
              <ul class="nav nav-tabs" id="userTabs" role="tablist">
                  <li class="nav-item" role="presentation">
                  <button class="nav-link active" id="oyun-tab" data-bs-toggle="tab" data-bs-target="#oyun" type="button" role="tab">Oyun</button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link " id="anketler-tab" data-bs-toggle="tab" data-bs-target="#anketler" type="button" role="tab">Anketler</button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="raporlar-tab" data-bs-toggle="tab" data-bs-target="#raporlar" type="button" role="tab">Raporlar</button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="analizler-tab" data-bs-toggle="tab" data-bs-target="#analizler" type="button" role="tab">Analizler</button>
             
              </ul>

              
  

              
              <div class="tab-content p-4" id="userTabsContent">
                  <div class="tab-pane fade show active" id="oyun" role="tabpanel">
                    <section id="mainpage" class="video">
      <video autoplay="" muted="" loop="" playsinline="" class="bg-video">
        <source src="video.mp4" type="video/mp4" />
      </video>
      <a
        class="btn btn-danger rounded-5 px-3"
        href="#"
        id="btnoyna"
        style="z-index: +1"
        >Oyun Oyna</a>
    </div>
      



            
                <div class="tab-pane fade show" id="anketler" role="tabpanel">
                  <h4 class="mb-4">Mevcut Anketler</h4>
                  
                  <div class="row">
                    <div class="col-md-6 mb-4">
                      <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                          <div class="d-flex justify-content-between align-items-start mb-3">
                            <h5 class="card-title mb-0">Depresyon Tarama Testi</h5>
                            <span class="badge bg-success">Tamamlandı</span>
                          </div>
                          <p class="card-text text-muted small">Son tamamlanma: 15.06.2023</p>
                          <div class="progress mb-3" style="height: 6px;">
                            <div class="progress-bar bg-success" role="progressbar" style="width: 100%;"></div>
                          </div>
                          <a href="#" class="btn btn-sm btn-outline-primary">Sonuçları Görüntüle</a>
                          <a href="#" class="btn btn-sm btn-outline-secondary ms-2">Testi Tekrarla</a>
                        </div>
                      </div>
                    </div>
                    
                    <div class="col-md-6 mb-4">
                      <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                          <div class="d-flex justify-content-between align-items-start mb-3">
                            <h5 class="card-title mb-0">Anksiyete Ölçeği</h5>
                            <span class="badge bg-warning text-dark">Devam Ediyor</span>
                          </div>
                          <p class="card-text text-muted small">Son güncelleme: 20.06.2023</p>
                          <div class="progress mb-3" style="height: 6px;">
                            <div class="progress-bar bg-warning" role="progressbar" style="width: 65%;"></div>
                          </div>
                          <a href="#" class="btn btn-sm btn-primary">Teste Devam Et</a>
                        </div>
                      </div>
                    </div>
                    
                    <div class="col-md-6 mb-4">
                      <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                          <div class="d-flex justify-content-between align-items-start mb-3">
                            <h5 class="card-title mb-0">Kişilik Envanteri</h5>
                            <span class="badge bg-danger">Başlanmadı</span>
                          </div>
                          <p class="card-text text-muted small">Son erişim: Hiç</p>
                          <div class="progress mb-3" style="height: 6px;">
                            <div class="progress-bar bg-danger" role="progressbar" style="width: 0%;"></div>
                          </div>
                          <a href="#" class="btn btn-sm btn-danger">Teste Başla</a>
                        </div>
                      </div>
                    </div>
                    
                    <div class="col-md-6 mb-4">
                      <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                          <div class="d-flex justify-content-between align-items-start mb-3">
                            <h5 class="card-title mb-0">Stres Düzeyi Testi</h5>
                            <span class="badge bg-success">Tamamlandı</span>
                          </div>
                          <p class="card-text text-muted small">Son tamamlanma: 10.06.2023</p>
                          <div class="progress mb-3" style="height: 6px;">
                            <div class="progress-bar bg-success" role="progressbar" style="width: 100%;"></div>
                          </div>
                          <a href="#" class="btn btn-sm btn-outline-primary">Sonuçları Görüntüle</a>
                          <a href="#" class="btn btn-sm btn-outline-secondary ms-2">Testi Tekrarla</a>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Raporlar Tab -->
                <div class="tab-pane fade" id="raporlar" role="tabpanel">
                  <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="mb-0">Raporlarım</h4>
                    <button class="btn btn-sm btn-outline-primary">
                      <i class="bi bi-download"></i> Tümünü İndir
                    </button>
                  </div>
                  
                  <div class="table-responsive">
                    <table class="table table-hover">
                      <thead>
                        <tr>
                          <th>Rapor Adı</th>
                          <th>Oluşturulma Tarihi</th>
                          <th>İşlemler</th>
                        </tr>
                      </thead>
                     
                      <tbody>
                        <tr>
                          <td>Psikolojik Değerlendirme Raporu</td>
                          <td class="report-date-cell">--</td>
                          <td>
                           
                            <button class="btn btn-sm btn-outline-primary" id="view-psychology-report-btn">Görüntüle</button>
                            <button class="btn btn-sm btn-outline-danger">İndir</button>
                          </td>
                        </tr>
                        <!-- Diğer rapor satırları -->
                        <tr>
                          <td>Terapi Süreci Değerlendirmesi</td>
                          <td>10.06.2023</td>
                          <td><button class="btn btn-sm btn-outline-primary">Görüntüle</button> ... </td>
                        </tr>
                        <tr>
                          <td>İlk Görüşme Notları</td>
                          <td>05.06.2023</td>
                          <td><button class="btn btn-sm btn-outline-primary" disabled>Görüntüle</button></td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                  <div id="report-status-container" class="mt-4"></div>
                </div>
              <!-- Analizler Tab -->
<div class="tab-pane fade" id="analizler" role="tabpanel">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="mb-0">Psikolojik Analizlerim</h4>
    <div>
      <button class="btn btn-sm btn-outline-primary me-2" id="btn-general-analysis">
        <i class="bi bi-graph-up"></i> Genel Analiz
      </button>
      <button class="btn btn-sm btn-outline-secondary" id="load-analyses-btn">
        <i class="bi bi-bar-chart-line"></i> Rapor Bazlı Analiz
      </button>
    </div>
  </div>
  <div id="analyses-container" class="row">
    <div class="col-12 text-center py-5">
      <div class="spinner-border"></div>
      <p class="mt-2 text-muted">Analiz yükleniyor...</p>
    </div>
  </div>
</div>
          
          
            </div>
          </div>
        </div>
      </div>
    </div>


    <script>
      document.addEventListener('DOMContentLoaded', function() {
          
          // ==========================================================
          // GİRİŞ YAPAN KULLANICI BİLGİLERİNİ SAYFAYA YAZDIRMA
          // ==========================================================
          const loggedInUsername = localStorage.getItem('username');
          const loggedInUserEmail = localStorage.getItem('userEmail'); 
          
          if (loggedInUsername) {
              // Sidebar'daki ismi bul ve güncelle
              const sidebarNameElement = document.querySelector('.card-body.text-center h5.mb-1');
              if (sidebarNameElement) {
                  sidebarNameElement.textContent = loggedInUsername;
              }
    
              // Navbar'daki butonun metnini güncelle
              const dropdownButton = document.getElementById('dropdownMenuButton');
              if(dropdownButton) {
                  dropdownButton.innerHTML = `<i class="bi bi-person-circle me-1"></i> ${loggedInUsername}`;
              } else {
                  // Eğer dropdown yoksa, sağ üstteki genel "Kullanıcı" butonunu bul
                  const userButton = document.querySelector('a.btn.btn-outline-primary');
                  if (userButton && userButton.textContent.includes('Kullanıcı')) {
                      userButton.innerHTML = `<i class="bi bi-person-circle"></i> ${loggedInUsername}`;
                  }
              }
          }
    
          if (loggedInUserEmail) {
              // Sidebar'daki e-postayı bul ve güncelle
              const emailElement = document.querySelector('.card-body.text-center p.text-muted.small');
              if (emailElement) {
                  emailElement.textContent = loggedInUserEmail;
              }
          }
    
          // ==========================================================
          // ÇIKIŞ YAPMA İŞLEVSELLİĞİ
          // ==========================================================
          const logoutLink = document.querySelector('a[href="index.html"].text-danger');
          if (logoutLink) {
              logoutLink.addEventListener('click', function(event) {
                  event.preventDefault();
                  localStorage.clear();
                  alert('Başarıyla çıkış yaptınız.');
                  window.location.href = 'index.html';
              });
          }
      
          // ==========================================================
          // OYUN OYNAMA BUTONU İŞLEVSELLİĞİ
          // ==========================================================
          const oynaButonu = document.getElementById('btnoyna');
          if (oynaButonu) {
              const loggedInUserId = localStorage.getItem('userId');
              if (loggedInUserId) {
                  const baseUrl = window.location.origin;   // Bulunduğun domain (örn: https://xxxxxxxxx.com)
                  oynaButonu.href = `${baseUrl}/oyun?userId=${loggedInUserId}`;
              } else {
                  oynaButonu.style.display = "none"; // login yoksa butonu gizle
              }
          }

                
          // ==========================================================
          // PSİKOLOJİK RAPOR GÖRÜNTÜLEME İŞLEVSELLİĞİ
          // ==========================================================
          const viewReportButton = document.getElementById('view-psychology-report-btn'); // HTML'de <button id="view-psychology-report-btn">...
          const reportStatusContainer = document.getElementById('report-status-container'); // HTML'de <div id="report-status-container">...
          
          if (viewReportButton && reportStatusContainer) {
              viewReportButton.addEventListener('click', async () => {
                  const currentUserId = localStorage.getItem('userId');
          
                  if (!currentUserId) {
                      alert("Bu işlem için giriş yapmış olmalısınız.");
                      return;
                  }
          
                  viewReportButton.disabled = true;
                  viewReportButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Aranıyor...';
                  reportStatusContainer.innerHTML = '';
          
                  try {
                      const response = await fetch("/.netlify/functions/generate-report", {
                          method: "POST",
                          headers: { "Content-Type": "application/json" },
                          body: JSON.stringify({ playerId: currentUserId }) 
                      });
          
                      const result = await response.json();
          
                      if (response.ok && result.success) {
                          reportStatusContainer.innerHTML = `
                              <div class="alert alert-success d-flex justify-content-between align-items-center">
                                  <span>${result.message}</span>
                                  <a href="${result.pdfLink}" target="_blank" class="btn btn-success btn-sm">PDF'i Aç</a>
                              </div>
                          `;
                      } else {
                          reportStatusContainer.innerHTML = `
                              <div class="alert alert-warning">${result.message || 'Bir hata oluştu.'}</div>
                          `;
                      }
          
                  } catch (error) {
                      reportStatusContainer.innerHTML = `
                          <div class="alert alert-danger">Sunucu ile iletişim kurulamadı. Lütfen tekrar deneyin.</div>
                      `;
                  } finally {
                      viewReportButton.disabled = false;
                      viewReportButton.innerHTML = 'Görüntüle';
                  }
              });
          }

          // ==========================================================
          // RAPORLARIM TABLOSUNU DOLDURMA
          // ==========================================================
          const raporlarTableBody = document.querySelector('#raporlar table tbody');

          async function loadReports() {
          const username = localStorage.getItem('username');
          if (!username) return;

          try {
            const response = await fetch(`https://unity-choice-api-production-8a70.up.railway.app/api/user-report/${username}`);
            const data = await response.json();

            raporlarTableBody.innerHTML = "";

            if (response.ok && data.reportLink) {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>Psikolojik Değerlendirme Raporu</td>
              <td>${
                data.generatedAt 
                  ? new Date(data.generatedAt).toLocaleDateString("tr-TR") 
                  : "--"
              }</td>
              
              <td>
                <a href="${data.reportLink}" target="_blank" class="btn btn-sm btn-outline-primary">Görüntüle</a>
                <a href="${data.reportLink}?download=${encodeURIComponent('rapor.pdf')}" class="btn btn-sm btn-outline-danger">İndir</a>
              </td>
            `;
            raporlarTableBody.appendChild(tr);
          } else {
            raporlarTableBody.innerHTML = `<tr><td colspan="3">Rapor bulunamadı.</td></tr>`;
          }
          } catch (err) {
            console.error("Rapor yükleme hatası:", err);
            raporlarTableBody.innerHTML = `<tr><td colspan="3">Sunucu hatası.</td></tr>`;
          }
        }

          // Sayfa açıldığında raporları yükle
          loadReports();

   

      });
    </script>

       <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

   <script>
     async function showGeneralAnalysis() {
  const analysesContainer = document.getElementById("analyses-container");
  analysesContainer.innerHTML = `<div class="col-12 text-center py-5"><div class="spinner-border"></div></div>`;

  const username = localStorage.getItem("username");
  if (!username) return;

  try {
    const response = await fetch(`https://unity-choice-api-production-8a70.up.railway.app/api/user-report/${username}`);
    const data = await response.json();

    // ✅ burada API'nin bir rapor listesi döndürdüğünü varsayıyoruz
    const reports = data.reports || data; // bazen doğrudan array olabilir

    if (!response.ok || !reports || reports.length === 0) {
      analysesContainer.innerHTML = `<p class="text-danger">Rapor bulunamadı.</p>`;
      return;
    }

    // Tarihe göre sırala
    reports.sort((a, b) => new Date(a.generatedAt) - new Date(b.generatedAt));

    const labels = reports.map(r =>
      r.generatedAt ? new Date(r.generatedAt).toLocaleDateString("tr-TR") : "?"
    );

    const traits = [
      { key: "Disadonukluk", label: "Dışadönüklük", color: "#0d6efd" },
      { key: "Uyumluluk", label: "Uyumluluk", color: "#198754" },
      { key: "Sorumluluk", label: "Sorumluluk", color: "#fd7e14" },
      { key: "DuygusalDenge", label: "Duygusal Denge", color: "#dc3545" }
    ];

    analysesContainer.innerHTML = `
      <div class="col-12 mb-4">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <h5 class="card-title">Genel Analiz</h5>
            <canvas id="chart-general"></canvas>
            <div id="general-warnings" class="mt-3"></div>
          </div>
        </div>
      </div>
    `;

    new Chart(document.getElementById("chart-general"), {
      type: "line",
      data: {
        labels,
        datasets: traits.map(trait => ({
          label: trait.label,
          data: reports.map(r => r[trait.key] ?? 0),
          borderColor: trait.color,
          backgroundColor: trait.color,
          tension: 0.3,
          pointRadius: 5,
          pointHoverRadius: 7,
          fill: false
        }))
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            ticks: { callback: v => v + "%" }
          }
        }
      }
    });

    // %20 düşüş kontrolü
    const warnDiv = document.getElementById("general-warnings");
    traits.forEach(trait => {
      const values = reports.map(r => r[trait.key] ?? 0);
      for (let i = 1; i < values.length; i++) {
        if (values[i - 1] - values[i] >= 20) {
          warnDiv.innerHTML += `
            <div class="alert alert-warning p-2 my-1">
              ⚠️ <strong>${trait.label}</strong> ${labels[i - 1]} → ${labels[i]} arasında 
              %${values[i - 1] - values[i]} düştü!
            </div>`;
        }
      }
    });

  } catch (err) {
    console.error("Genel analiz hata:", err);
    analysesContainer.innerHTML = `<p class="text-danger">Sunucu hatası.</p>`;
  }
}
</script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
