<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Giriş ve Kayıt</title>
    <link rel="stylesheet" href="Giriş.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body>
    <div class="logo">
      <i class="fas fa-graduation-cap"></i>
      <span>KutAI</span>
    </div>

    <div class="main">
      <div class="user-type-selector">
        <button class="user-type-btn active" id="student-btn">
          <i class="fas fa-user-graduate"></i> Öğrenci
        </button>
        <button class="user-type-btn" id="teacher-btn">
          <i class="fas fa-chalkboard-teacher"></i> Öğretmen
        </button>
      </div>

      <input type="checkbox" id="chk" aria-hidden="true" />

      <div class="signup">
        <form id="register-form">
          <label> <i class="fas fa-user-plus"></i> Kayıt Ol </label>

          <div id="register-message" class="message-box"></div>

          <div class="input-group">
            <i class="fas fa-user input-icon"></i>
            <input
              type="text"
              name="name"
              placeholder=" "
              required
              id="register-name"
            />
            <span class="floating-label">Adınız</span>
          </div>

          <div class="input-group">
            <i class="fas fa-user input-icon"></i>
            <input
              type="text"
              name="surname"
              placeholder=" "
              required
              id="register-surname"
            />
            <span class="floating-label">Soyadınız</span>
          </div>

          <div class="input-group">
            <i class="fas fa-envelope input-icon"></i>
            <input
              type="email"
              name="email"
              placeholder=" "
              required
              id="register-email"
            />
            <span class="floating-label">Emailiniz</span>
          </div>

          <div class="input-group">
            <i class="fas fa-at input-icon"></i>
            <input
              type="text"
              name="username"
              placeholder=" "
              required
              id="register-username"
            />
            <span class="floating-label">Kullanıcı Adınız</span>
          </div>

          <div class="input-group">
            <i class="fas fa-lock input-icon"></i>
            <div class="password-container">
              <input
                type="password"
                id="registerPassword"
                name="password"
                placeholder=" "
                required
              />
              <span class="floating-label">Şifre</span>
              <span
                class="eye-icon"
                onclick="togglePasswordVisibility('registerPassword', this)"
              >
                <i class="far fa-eye"></i>
              </span>
            </div>
          </div>

          <button type="submit" id="register-button">
            <i class="fas fa-user-plus"></i> Kayıt Ol
          </button>

          <div class="divider">
            <div class="divider-line"></div>
            <div class="divider-text">veya</div>
            <div class="divider-line"></div>
          </div>

          <p class="info-text">
            Hesabınız var mı? <a onclick="toggleForm()">Giriş yapın</a>
          </p>
        </form>
      </div>

      <div class="login">
        <form id="login-form">
          <label> <i class="fas fa-sign-in-alt"></i> Giriş Yap </label>
          <!-- Giriş formu için mesaj kutusu -->
          <div id="login-message" class="message-box"></div>

          <div class="input-group">
            <i class="fas fa-at input-icon"></i>
            <input
              type="text"
              name="username"
              placeholder=" "
              required
              id="login-username"
            />
            <span class="floating-label">Kullanıcı Adı</span>
          </div>

          <div class="input-group">
            <i class="fas fa-lock input-icon"></i>
            <div class="password-container">
              <input
                type="password"
                id="loginPassword"
                name="pswd"
                placeholder=" "
                required
              />
              <span class="floating-label">Şifre</span>
              <span
                class="eye-icon"
                onclick="togglePasswordVisibility('loginPassword', this)"
              >
                <i class="far fa-eye"></i>
              </span>
            </div>
          </div>

          <button type="submit" id="login-button">
            <i class="fas fa-sign-in-alt"></i> Giriş Yap
          </button>

          <div class="divider">
            <div class="divider-line"></div>
            <div class="divider-text">veya</div>
            <div class="divider-line"></div>
          </div>

          <p class="info-text">
            Hesabınız yok mu? <a onclick="toggleForm()">Kayıt olun</a>
          </p>
        </form>
      </div>
    </div>

    <script>
      function togglePasswordVisibility(fieldId, iconElement) {
        const passwordField = document.getElementById(fieldId);
        if (passwordField) {
          const isPassword = passwordField.type === "password";
          passwordField.type = isPassword ? "text" : "password";

          const icon = iconElement.querySelector("i");
          if (isPassword) {
            icon.classList.remove("fa-eye");
            icon.classList.add("fa-eye-slash");
          } else {
            icon.classList.remove("fa-eye-slash");
            icon.classList.add("fa-eye");
          }
        }
      }

      // Mesaj gösterme fonksiyonu
      function showMessage(elementId, message, type) {
        const messageBox = document.getElementById(elementId);
        if (messageBox) {
          messageBox.innerHTML = ""; // Önceki içeriği temizle
          messageBox.className = "message-box"; // Tüm sınıfları sıfırla

          let iconClass = "";
          if (type === "success") {
            messageBox.classList.add("success");
            iconClass = "fas fa-check-circle";
          } else if (type === "error") {
            messageBox.classList.add("error");
            iconClass = "fas fa-exclamation-circle";
          }

          if (message) {
            // Sadece mesaj varsa içeriği ve ikonları göster
            messageBox.innerHTML = `<i class="${iconClass}"></i> ${message}`;
            messageBox.classList.add("show");

            // Başarılı mesajları yönlendirmeden önce görmek için
            if (type === "success") {
              setTimeout(() => {
                messageBox.classList.remove("show");
              }, 2000); // 2 saniye sonra gizle
            } else {
              // Hata mesajlarını 5 saniye sonra gizle
              setTimeout(() => {
                messageBox.classList.remove("show");
              }, 5000);
            }
          } else {
            // Mesaj boşsa gizle
            messageBox.classList.remove("show");
          }
        }
      }

      function toggleForm() {
        const chk = document.getElementById("chk");
        chk.checked = !chk.checked;

        const event = new Event("change");
        chk.dispatchEvent(event);

        // Form değiştirildiğinde mesaj kutularını temizle
        showMessage("register-message", "", "");
        showMessage("login-message", "", "");
      }

      document.addEventListener("DOMContentLoaded", function () {
        const studentBtn = document.getElementById("student-btn");
        const teacherBtn = document.getElementById("teacher-btn");

        const chk = document.getElementById("chk");
        const mainContainer = document.querySelector(".main");

        chk.addEventListener("change", function () {
          if (this.checked) {
            // Kayıt formu aktifse yüksekliği artır
            mainContainer.style.height = "750px";
          } else {
            // Giriş formu aktifse yüksekliği azalt
            mainContainer.style.height = "540px";
          }
          // Form değişiminde mesajları temizle
          showMessage("register-message", "", "");
          showMessage("login-message", "", "");
        });

        studentBtn.addEventListener("click", function () {
          studentBtn.classList.add("active");
          teacherBtn.classList.remove("active");
          document.querySelectorAll("form label").forEach((label) => {
            if (label.querySelector("i").classList.contains("fa-sign-in-alt")) {
              label.innerHTML =
                '<i class="fas fa-sign-in-alt"></i> Öğrenci Girişi';
            } else {
              label.innerHTML =
                '<i class="fas fa-user-plus"></i> Öğrenci Kaydı';
            }
          });
          showMessage("register-message", "", "");
          showMessage("login-message", "", "");
        });

        teacherBtn.addEventListener("click", function () {
          teacherBtn.classList.add("active");
          studentBtn.classList.remove("active");
          document.querySelectorAll("form label").forEach((label) => {
            if (label.querySelector("i").classList.contains("fa-sign-in-alt")) {
              label.innerHTML =
                '<i class="fas fa-sign-in-alt"></i> Öğretmen Girişi';
            } else {
              label.innerHTML =
                '<i class="fas fa-user-plus"></i> Öğretmen Kaydı';
            }
          });
          showMessage("register-message", "", "");
          showMessage("login-message", "", "");
        });

        const registerForm = document.getElementById("register-form");
        if (registerForm) {
          registerForm.addEventListener("submit", async function (event) {
            event.preventDefault();
            const registerButton = document.getElementById("register-button");
            registerButton.disabled = true;
            registerButton.innerHTML =
              '<i class="fas fa-spinner fa-spin"></i> Kaydediliyor...';

            // Önceki mesajları temizle
            showMessage("register-message", "", "");

            try {
              const formData = {
                name: document.getElementById("register-name").value,
                surname: document.getElementById("register-surname").value,
                email: document.getElementById("register-email").value,
                username: document.getElementById("register-username").value,
                password: document.getElementById("registerPassword").value,
                userType: studentBtn.classList.contains("active")
                  ? "student"
                  : "teacher",
              };

              const response = await fetch("/.netlify/functions/register", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(formData),
              });

              const result = await response.json();
              if (response.ok) {
                showMessage(
                  "register-message",
                  result.message || "Kayıt başarılı!",
                  "success"
                );

                registerForm.reset();

                setTimeout(() => {
                  toggleForm();
                }, 2000);
              } else {
                showMessage(
                  "register-message",
                  result.message || "Bilinmeyen bir hata oluştu.",
                  "error"
                );
              }
            } catch (error) {
              console.error("Kayıt sırasında hata:", error);
              showMessage(
                "register-message",
                "Bir ağ hatası oluştu. Lütfen tekrar deneyin.",
                "error"
              );
            } finally {
              registerButton.disabled = false;
              registerButton.innerHTML =
                '<i class="fas fa-user-plus"></i> Kayıt Ol';
            }
          });
        }

        const loginForm = document.getElementById("login-form");
        if (loginForm) {
          loginForm.addEventListener("submit", async function (event) {
            event.preventDefault();

            const loginButton = document.getElementById("login-button");
            loginButton.disabled = true;
            loginButton.innerHTML =
              '<i class="fas fa-spinner fa-spin"></i> Giriş Yapılıyor...';

            // Önceki mesajları temizle
            showMessage("login-message", "", "");

            try {
              const loginData = {
                username: document.getElementById("login-username").value,
                password: document.getElementById("loginPassword").value,
                userType: studentBtn.classList.contains("active")
                  ? "student"
                  : "teacher",
              };

              const response = await fetch("/.netlify/functions/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(loginData),
              });

              // Yanıtı JSON olarak parse etmeye çalış
              let result;
              try {
                result = await response.json();
              } catch (e) {
                throw new Error("Sunucudan geçersiz yanıt alındı.");
              }
              if (response.ok && result.token) {
                localStorage.setItem("userToken", result.token);
                localStorage.setItem("userId", result.userId);
                localStorage.setItem("username", loginData.username);
                localStorage.setItem("userEmail", result.email);
                localStorage.setItem("userType", loginData.userType);

                showMessage(
                  "login-message",
                  result.message || "Giriş başarılı!",
                  "success"
                );

                setTimeout(() => {
                  if (loginData.userType === "student") {
                    window.location.href = "main.html";
                  } else if (loginData.userType === "teacher") {
                    window.location.href = "OgretmenSayfa.html";
                  } else {
                    window.location.href = "index.html";
                  }
                }, 2000);
              } else {
                // Giriş başarısızsa yönlendirme YAPMA, sadece hata göster
                showMessage(
                  "login-message",
                  result.message || "Kullanıcı adı veya şifre hatalı.",
                  "error"
                );
              }
            } catch (error) {
              console.error("HATA:", error);
              showMessage(
                "login-message",
                error.message || "Bir ağ hatası oluştu. Lütfen tekrar deneyin.",
                "error"
              );
            } finally {
              loginButton.disabled = false;
              loginButton.innerHTML =
                '<i class="fas fa-sign-in-alt"></i> Giriş Yap';
            }
          });
        }
      });
    </script>
  </body>
</html>
